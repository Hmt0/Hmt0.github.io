<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ä»0å¼€å§‹å®ç°ä¸€ä¸ªReact | hmtçš„åšå®¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡æ•™ä½ æ„å»ºä¸€ä¸ªReact çš„æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œè€Œä¸”äº¤äº’ä¹Ÿåšå¾—ç‰¹åˆ«æ£’ï¼Œåœ¨æ­¤ç¿»è¯‘è®°å½•ä¸€ä¸‹ã€‚ è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯éµå¾ªReactä»£ç çš„ä½“ç³»ç»“æ„ä¸€æ­¥æ­¥åœ°å†™å‡ºä¸€ä¸ªç®€å•çš„Reactï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚ è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š  The createElement Function The render Function å¹¶å‘æ¨¡å‹ Fibers æ¸²æŸ“å’Œæäº¤é˜¶æ®µ åè°ƒ å‡½æ•°ç»„ä»¶ Hook">
<meta property="og:type" content="article">
<meta property="og:title" content="ä»0å¼€å§‹å®ç°ä¸€ä¸ªReact">
<meta property="og:url" content="http://hemengting.xyz/2021/10/17/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAReact/index.html">
<meta property="og:site_name" content="hmtçš„åšå®¢">
<meta property="og:description" content="æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡æ•™ä½ æ„å»ºä¸€ä¸ªReact çš„æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œè€Œä¸”äº¤äº’ä¹Ÿåšå¾—ç‰¹åˆ«æ£’ï¼Œåœ¨æ­¤ç¿»è¯‘è®°å½•ä¸€ä¸‹ã€‚ è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯éµå¾ªReactä»£ç çš„ä½“ç³»ç»“æ„ä¸€æ­¥æ­¥åœ°å†™å‡ºä¸€ä¸ªç®€å•çš„Reactï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚ è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š  The createElement Function The render Function å¹¶å‘æ¨¡å‹ Fibers æ¸²æŸ“å’Œæäº¤é˜¶æ®µ åè°ƒ å‡½æ•°ç»„ä»¶ Hook">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:/Users/luna6/AppData/Roaming/Typora/typora-user-images/image-20211018223652632.png">
<meta property="article:published_time" content="2021-10-17T04:18:53.000Z">
<meta property="article:modified_time" content="2022-01-18T09:31:37.893Z">
<meta property="article:author" content="He Mengting">
<meta property="article:tag" content="react babel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/luna6/AppData/Roaming/Typora/typora-user-images/image-20211018223652632.png">
  
    <link rel="alternate" href="/atom.xml" title="hmtçš„åšå®¢" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hmtçš„åšå®¢</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hemengting.xyz"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-ä»0å¼€å§‹å®ç°ä¸€ä¸ªReact" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/17/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAReact/" class="article-date">
  <time class="dt-published" datetime="2021-10-17T04:18:53.000Z" itemprop="datePublished">2021-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ä»0å¼€å§‹å®ç°ä¸€ä¸ªReact
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡<a target="_blank" rel="noopener" href="https://pomb.us/build-your-own-react/">æ•™ä½ æ„å»ºä¸€ä¸ªReact</a> çš„æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œè€Œä¸”äº¤äº’ä¹Ÿåšå¾—ç‰¹åˆ«æ£’ï¼Œåœ¨æ­¤ç¿»è¯‘è®°å½•ä¸€ä¸‹ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯éµå¾ªReactä»£ç çš„ä½“ç³»ç»“æ„ä¸€æ­¥æ­¥åœ°å†™å‡ºä¸€ä¸ªç®€å•çš„Reactï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚</p>
<p>è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>The <code>createElement</code> Function</li>
<li>The <code>render</code> Function</li>
<li>å¹¶å‘æ¨¡å‹</li>
<li>Fibers</li>
<li>æ¸²æŸ“å’Œæäº¤é˜¶æ®µ</li>
<li>åè°ƒ</li>
<li>å‡½æ•°ç»„ä»¶</li>
<li>Hooks</li>
</ol>
<h2 id="1ï¼šå‡†å¤‡"><a href="#1ï¼šå‡†å¤‡" class="headerlink" title="-1ï¼šå‡†å¤‡"></a>-1ï¼šå‡†å¤‡</h2><p>é¦–å…ˆï¼Œ<code>JSX</code>è¯­æ³•æ˜¯é€šè¿‡Babelè½¬æ¢æˆJavaScriptçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®ä¸­é…ç½®Babelã€‚</p>
<p>å®‰è£…ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/core @babel/cli @babel/preset-env @babel/preset-react</span><br></pre></td></tr></table></figure>

<p>åœ¨æ ¹ç›®å½•ä¸­æ·»åŠ <code>.babelrc</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;presets&quot;</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>, <span class="string">&quot;@babel/preset-react&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>.babel.config.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> presets = [</span><br><span class="line">  [</span><br><span class="line">    <span class="string">&quot;@babel/env&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">targets</span>: &#123;</span><br><span class="line">        <span class="attr">edge</span>: <span class="string">&quot;17&quot;</span>,</span><br><span class="line">        <span class="attr">firefox</span>: <span class="string">&quot;60&quot;</span>,</span><br><span class="line">        <span class="attr">chrome</span>: <span class="string">&quot;67&quot;</span>,</span><br><span class="line">        <span class="attr">safari</span>: <span class="string">&quot;11.1&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">useBuiltIns</span>: <span class="string">&quot;usage&quot;</span>,</span><br><span class="line">      <span class="attr">corejs</span>: <span class="string">&quot;3.6.4&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; presets &#125;;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ<code>npx babel src --out-dir lib</code>å°±å¯ä»¥æŠŠè½¬æ¢ç»“æœä¿å­˜åœ¨libæ–‡ä»¶å¤¹ä¸‹é¢äº†~</p>
<h2 id="0ï¼šå›é¡¾"><a href="#0ï¼šå›é¡¾" class="headerlink" title="0ï¼šå›é¡¾"></a>0ï¼šå›é¡¾</h2><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†æ¸²æŸ“ä¸€ä¸ªReactç»„ä»¶çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">title</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span> <span class="comment">// å®šä¹‰Reactç»„ä»¶</span></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>) <span class="comment">// ä»DOMä¸­è·å–ä¸€ä¸ªèŠ‚ç‚¹container</span></span><br><span class="line">ReactDOM.render(element, container) <span class="comment">// æŠŠReactç»„ä»¶æ¸²æŸ“åˆ°container</span></span><br></pre></td></tr></table></figure>

<p>è¦å®ç°ä¸€ä¸ªReactï¼Œé¦–å…ˆè¦çŸ¥é“Reactçš„æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œç”¨åŸç”Ÿçš„JavaScriptæ€ä¹ˆå†™ï¼Œå†å»å°è£…æˆæˆ‘ä»¬çš„æ–¹æ³•ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸ä½¿ç”¨Reactè¯­æ³•æ¥å®ç°ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<ol>
<li><h4 id="å®šä¹‰ç»„ä»¶"><a href="#å®šä¹‰ç»„ä»¶" class="headerlink" title="å®šä¹‰ç»„ä»¶"></a>å®šä¹‰ç»„ä»¶</h4></li>
</ol>
<p>Babelè½¬æ¢<code>JSX</code>çš„è§„åˆ™å°±æ˜¯ç”¨è°ƒç”¨<code>createElement</code>æ›¿æ¢<code>&lt;&gt;</code>å†…éƒ¨çš„ä»£ç ï¼Œå°†<code>tag name</code>ã€<code>props</code>å’Œå­å…ƒç´ ä½œä¸ºå‚æ•°ä¼ é€’ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = React.createElement(</span><br><span class="line">  <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  <span class="string">&quot;Hello&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>React.createElement</code>ä¼šå¯¹å‚æ•°åšä¸€äº›éªŒè¯å¹¶è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé•¿è¿™æ ·ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªå¯¹è±¡æ›¿æ¢å‡½æ•°è°ƒç”¨ã€‚<code>type</code>å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜DOMèŠ‚ç‚¹çš„ç±»å‹ï¼Œå°±æ˜¯åœ¨ç”ŸæˆHTMLå…ƒç´ æ—¶å°†è¦ä¼ ç»™<code>document.createElement</code>çš„<code>tagName</code>ã€‚</p>
<p><code>props</code>å±æ€§æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬<code>JSX</code>å±æ€§çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š<code>children</code>ï¼š</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­<code>children</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å®ƒé€šå¸¸æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå…ƒç´ çš„æ•°ç»„ã€‚æ‰€ä»¥å…ƒç´ å®æ•°å‹ç»“æ„çš„ã€‚</p>
<ol start="2">
<li><h4 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“"></a>æ¸²æŸ“</h4></li>
</ol>
<p>ï¼ˆ<code>container</code>æ˜¯ç›´æ¥è°ƒç”¨<code>document.getElementById</code>è·å–çš„ä¸ç”¨ç®¡ã€‚ï¼‰å¦ä¸€ä¸ªæˆ‘ä»¬è¦æ›¿æ¢çš„Reactä»£ç æ˜¯<code>ReactDOM.render</code>çš„è°ƒç”¨ã€‚<code>render</code>æ˜¯Reactä¿®æ”¹DOMçš„åœ°æ–¹ï¼Œå› æ­¤æˆ‘ä»¬è¦åœ¨è¿™é‡Œå®ç°DOMæ›´æ–°ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬ç”¨<code>type</code>å±æ€§åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹*ï¼Œæœ¬ä¾‹ä¸­æ˜¯<code>h1</code>ã€‚ç„¶åæˆ‘ä»¬æŠŠå…ƒç´ çš„å…ƒç´ çš„å±æ€§åˆ†é…ç»™èŠ‚ç‚¹ï¼Œæœ¬ä¾‹ä¸­æ˜¯titleå±æ€§ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(element.type)</span><br><span class="line">node[<span class="string">&quot;title&quot;</span>] = element.props.title</span><br></pre></td></tr></table></figure>

<p>*ä¸ºäº†é¿å…æ··æ·†ï¼Œä¸‹æ–‡ä¸­ä½¿ç”¨â€å…ƒç´ â€è¡¨ç¤ºReactå…ƒç´ ï¼Œâ€œèŠ‚ç‚¹â€è¡¨ç¤ºDOMèŠ‚ç‚¹ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºå­èŠ‚ç‚¹ï¼Œæœ¬ä¾‹ä¸­åªæœ‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚ä½¿ç”¨<code>textNode</code>è€Œä¸æ˜¯<code>innerText</code>å¯ä»¥è®©æˆ‘ä»¬ç”¨åŒæ ·çš„æ–¹å¼å¤„ç†æ‰€æœ‰å…ƒç´ ï¼ˆæ–¹ä¾¿é€’å½’ï¼‰ã€‚æ³¨æ„æˆ‘ä»¬åƒå¤„ç†<code>h1</code>çš„titleä¸€æ ·ç»™æ–‡æœ¬èŠ‚ç‚¹è®¾ç½®<code>nodeValue</code>ï¼š<code>&#123;nodeValue: &quot;hello&quot;&#125;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> text = <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>)</span><br><span class="line">text[<span class="string">&quot;nodeValue&quot;</span>] = element.props.children</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬æŠŠ<code>textNode</code>æ·»åŠ åˆ°<code>h1</code>ï¼Œå†æŠŠ<code>h1</code>æ·»åŠ åˆ°<code>container</code>ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±åœ¨ä¸ä½¿ç”¨Reactçš„æƒ…å†µä¸‹å®ç°äº†åŒæ ·çš„åŠŸèƒ½ã€‚ç½—å—¦äº†è¿™ä¹ˆå¤šï¼Œå®ç°èµ·æ¥è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œç”¨è¿‡Reactçš„åŒå­¦åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(element.type)</span><br><span class="line">node[<span class="string">&quot;title&quot;</span>] = element.props.title</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> text = <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>)</span><br><span class="line">text[<span class="string">&quot;nodeValue&quot;</span>] = element.props.children</span><br><span class="line"></span><br><span class="line">node.appendChild(text)</span><br><span class="line">container.appendChild(node)</span><br></pre></td></tr></table></figure>

<h2 id="1ï¼šcreateElementå‡½æ•°"><a href="#1ï¼šcreateElementå‡½æ•°" class="headerlink" title="1ï¼šcreateElementå‡½æ•°"></a>1ï¼š<code>createElement</code>å‡½æ•°</h2><p>ï¼ˆä¸Šä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å®šä¹‰äº†elementå¯¹è±¡ï¼‰æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¯¥çœŸæ­£å®ç°ä¸€ä¸ªè‡ªå·±çš„<code>createElement</code>å‡½æ•°äº†ã€‚é¦–å…ˆæŠŠ<code>JSX</code>è½¬æ¢æˆ<code>JS</code>ç ”ç©¶ä¸€ä¸‹<code>createElement</code>æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = React.createElement(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  React.createElement(<span class="string">&quot;a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;bar&quot;</span>),</span><br><span class="line">  React.createElement(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>è¿˜è®°å¾—æˆ‘ä»¬ä¸Šä¸€æ­¥ä¸­å®šä¹‰çš„elementå¯¹è±¡å—ï¼Ÿæˆ‘ä»¬çš„å‡½æ•°çš„åŠŸèƒ½åº”è¯¥æ˜¯åˆ›å»ºä¸€ä¸ªå…·æœ‰<code>type</code>å’Œ<code>props</code>å±æ€§çš„å¯¹è±¡ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, props, ...children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      children,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨äº†å±•å¼€è¿ç®—ç¬¦å¤„ç†<code>props</code>ï¼Œä½¿ç”¨å‰©ä½™å‚æ•°å¤„ç†<code>children</code>ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›<code>children</code>å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚ä¾‹å¦‚ï¼Œ<code>createElement(&quot;div&quot;)</code>è¿”å›</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="string">&quot;props&quot;</span>: &#123; <span class="string">&quot;children&quot;</span>: [] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createElement(&quot;div&quot;, null, a)</code>è¿”å›</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="string">&quot;props&quot;</span>: &#123; <span class="string">&quot;children&quot;</span>: [a] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createElement(&quot;div&quot;, null, a, b)</code>è¿”å›</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="string">&quot;props&quot;</span>: &#123; <span class="string">&quot;children&quot;</span>: [a, b] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>children</code>æ•°ç»„æˆ–è®¸åŒ…å«å­—ç¬¦ä¸²æˆ–æ•°å­—è¿™æ ·çš„åŸå§‹å€¼ï¼ˆæ ‘ä¸­çš„å¶å­èŠ‚ç‚¹ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥åŒ…è£…ä¸æ˜¯å¯¹è±¡çš„å…ƒç´ ï¼Œå†ç»™å®ƒä»¬ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š<code>TEXT_ELEMENT</code>ã€‚</p>
<p>(è¿™é‡Œçš„ç®­å¤´å‡½æ•°æˆ‘ä¸€å¼€å§‹å¤šå†™äº†ä¸ªå¤§æ‹¬å·ï¼Œç„¶åå°±ä¸€ç›´æŠ¥é”™ï¼)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      <span class="attr">children</span>: children.map(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">        <span class="keyword">typeof</span> child === <span class="string">&quot;object&quot;</span></span><br><span class="line">          ? child</span><br><span class="line">          : createTextElement(child)</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTextElement</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;TEXT_ELEMENT&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">nodeValue</span>: text,</span><br><span class="line">      <span class="attr">children</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æ²¡æœ‰å­å…ƒç´ æ—¶ï¼ŒReactå¹¶æ²¡æœ‰åŒ…è£…åŸå§‹å€¼æˆ–åˆ›å»ºç©ºæ•°ç»„ï¼Œä½†æˆ‘ä»¬æ›´å¸Œæœ›ç®€åŒ–ä»£ç è€Œä¸æ˜¯è¿½æ±‚ä»£ç æ€§èƒ½ğŸ˜€ã€‚</p>
<p>ä¸ºäº†æ›¿æ¢Reactï¼Œæˆ‘ä»¬è¦ç»™è‡ªå·±çš„åº“èµ·ä¸ªåå­—ï¼Œå°±å«<code>Didact</code>å§ï¼ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶æƒ³ä½¿ç”¨<code>JSX</code>è¯­æ³•ï¼Œæ€ä¹ˆå‘Šè¯‰<code>babel</code>è¦ç”¨<code>Didact</code>çš„<code>createElement</code>è€Œä¸æ˜¯<code>React</code>çš„å‘¢ï¼Ÿ</p>
<p>ç”¨è¿™æ ·ä¸€ä¸ªæ³¨é‡Šï¼Œå½“babelç¼–è¯‘<code>JSX</code>æ—¶ï¼Œå°±ä¼šä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°è¾£ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx </span>Didact.createElement */</span></span><br><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">b</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="2-renderå‡½æ•°"><a href="#2-renderå‡½æ•°" class="headerlink" title="2.renderå‡½æ•°"></a>2.<code>render</code>å‡½æ•°</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å†™ä¸€ä¸ªè‡ªå·±çš„<code>ReactDOM.render</code>å‡½æ•°ã€‚ç°åœ¨å‘¢ï¼Œæˆ‘ä»¬åªå…³å¿ƒå‘DOMä¸­æ·»åŠ ä¸œè¥¿ï¼Œä¹‹åæˆ‘ä»¬å†å®ç°æ›´æ–°å’Œåˆ é™¤ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ ¹æ®<code>element type</code>ç”Ÿæˆä¸€ä¸ªDOMèŠ‚ç‚¹ï¼Œå†æŠŠè¿™ä¸ªæ–°èŠ‚ç‚¹æ·»åŠ åˆ°containerã€‚</p>
<p>æˆ‘ä»¬è¦é€’å½’åœ°å¯¹æ¯ä¸ªå­èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚åˆ«å¿˜äº†æ–‡æœ¬å…ƒç´ ï¼Œå¦‚æœå…ƒç´ ç±»å‹æ˜¯<code>TEXT_ELEMENT</code>æˆ‘ä»¬å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹è€Œä¸æ˜¯å¸¸è§„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.type == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="built_in">document</span>.createElement(element.type)</span><br><span class="line"></span><br><span class="line">  element.props.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    render(child, dom)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>æœ€åæˆ‘ä»¬éœ€è¦ç»™èŠ‚ç‚¹åˆ†é…å…ƒç´ å±æ€§ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isProperty = <span class="function"><span class="params">key</span> =&gt;</span> key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(element.props)</span><br><span class="line">    .filter(isProperty)</span><br><span class="line">    .forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = element.props[name]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>å®Œæˆï¼æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå¯ä»¥æŠŠ<code>JSX</code>æ¸²æŸ“åˆ°DOMä¸­çš„åº“ã€‚</p>
<h2 id="3-å¹¶å‘æ¨¡å‹"><a href="#3-å¹¶å‘æ¨¡å‹" class="headerlink" title="3.å¹¶å‘æ¨¡å‹"></a>3.å¹¶å‘æ¨¡å‹</h2><p>åœ¨å®ç°æ›´å¤šåŠŸèƒ½å‰Â·Â·Â·Â·Â·Â·æˆ‘ä»¬éœ€è¦é‡æ„ä¸€ä¸‹ä»£ç ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬çš„é€’å½’è°ƒç”¨æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ä¸€æ—¦æˆ‘ä»¬å¼€å§‹æ¸²æŸ“ï¼Œç›´åˆ°æˆ‘ä»¬æ¸²æŸ“å®Œæ•´æ£µelementæ ‘éƒ½ä¸ä¼šåœä¸‹æ¥ã€‚å¦‚æœè¿™æ£µelementæ ‘å¾ˆå¤§çš„è¯ï¼Œå®ƒå¯èƒ½ä¼šä½¿ä¸»çº¿ç¨‹é˜»å¡å¾ˆä¹…ã€‚è€Œä¸”å¦‚æœæµè§ˆå™¨éœ€è¦å®ç°ä¸€æ®µå¹³æ»‘çš„åŠ¨ç”»æˆ–è€…å¤„ç†ç”¨æˆ·è¾“å…¥è¿™ç§é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå®ƒå°†ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æ¸²æŸ“å®Œæˆã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å°†æŠŠå·¥ä½œæ‹†åˆ†æˆå°çš„å•å…ƒï¼Œè€Œä¸”æ¯å½“æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªå•å…ƒï¼Œå¦‚æœæœ‰å…¶ä»–äº‹æƒ…è¦åšçš„è¯æˆ‘ä»¬ä¼šè®©æµè§ˆå™¨æ‰“æ–­æ¸²æŸ“ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nextUnitOfWork = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> shouldYield = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) &#123; </span><br><span class="line">    <span class="comment">// ä»»åŠ¡åˆ—è¡¨ä¸­è¿˜æœ‰ä¸‹ä¸€ä¸ªå•å…ƒè€Œä¸”è¿˜æœ‰ç©ºé—²æ—¶é—´</span></span><br><span class="line">    nextUnitOfWork = performUnitOfWork(</span><br><span class="line">      <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">      nextUnitOfWork</span><br><span class="line">    )</span><br><span class="line">    shouldYield = deadline.timeRemaining() &lt; <span class="number">1</span></span><br><span class="line">   	<span class="comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—²æ—¶é—´</span></span><br><span class="line">  &#125;</span><br><span class="line">  requestIdleCallback(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestIdleCallback(workLoop)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">nextUnitOfWork</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä½¿ç”¨<code>requestIdleCallback</code>æ¥å®ç°å¾ªç¯ã€‚å¯ä»¥æŠŠ<code>reuqestIdleCallback</code>çœ‹ä½œä¸€ä¸ª<code>setTimeout    </code>,åªä¸è¿‡ä¸æ˜¯æˆ‘ä»¬å‘Šè¯‰ä»–ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œ<strong>æµè§ˆå™¨ä¼šåœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶è¿è¡Œå›è°ƒå‡½æ•°</strong>ã€‚</p>
<p>Reactä¸å†ä½¿ç”¨<code>requestIdleCallback</code>äº†ï¼Œç°åœ¨äººå®¶ç”¨<em>the scheduler package</em>ï¼Œä½†åœ¨æœ¬ä¾‹ä¸­æ˜¯ä¸€æ ·çš„æ¦‚å¿µã€‚</p>
<p><code>requestIdleCallback</code>è¿˜ç»™äº†æˆ‘ä»¬ä¸€ä¸ªdeadlineå‚æ•°ã€‚æˆ‘ä»¬å°±æ˜¯ç”¨å®ƒæ¥åˆ¤æ–­åœ¨æµè§ˆå™¨è·å¾—æŒæ§æƒä¹‹å‰æˆ‘ä»¬è¿˜æœ‰å¤šå°‘æ—¶é—´çš„ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡è®¾ç½®ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªå•å…ƒæ¥å¯åŠ¨å¾ªç¯ï¼Œæ¥ä¸‹æ¥å†™äº†ä¸€ä¸ª<code>performUnitOfWork</code>å‡½æ•°ï¼Œå³æ‰§è¡Œäº†ä»»åŠ¡åˆè¿”å›äº†ä»»åŠ¡ä¸­çš„ä¸‹ä¸€ä¸ªå•å…ƒã€‚</p>
<h2 id="4-Fibers"><a href="#4-Fibers" class="headerlink" title="4.Fibers"></a>4.<code>Fibers</code></h2><p>ï¼ˆç°åœ¨æˆ‘ä»¬è¿˜ä¸çŸ¥é“<code>nextUnitOfWork</code>é•¿å•¥æ ·ï¼Œä¹Ÿå°±æ— æ³•å®ç°<code>performUnitOfWork</code>ï¼‰ä¸ºäº†ç»„ç»‡ä»»åŠ¡ä¸­çš„æ‰€æœ‰å•å…ƒæˆ‘ä»¬éœ€è¦ä¸€ç§æ•°æ®ç»“æ„ï¼šé‚£å°±æ˜¯<code>fiber</code>æ ‘ã€‚</p>
<p>ï¼ˆFiberå°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„â€è™šæ‹ŸDOMâ€œï¼Œå…¶å®å°±æ˜¯å…ˆç”¨ä¸€ä¸ªå¯¹è±¡æ¥è¡¨è¿°è¿™ä¸ªèŠ‚ç‚¹çš„è‡ªèº«å±æ€§å’Œå®ƒçš„çˆ¶äº²å„¿å­å…„å¼Ÿçš„å…³ç³»ï¼‰</p>
<p><strong>æ¯ä¸€ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„<code>fiber</code>è€Œä¸”æ¯ä¸ª<code>fiber</code>éƒ½æ˜¯ä»»åŠ¡ä¸­çš„ä¸€ä¸ªå•å…ƒã€‚</strong></p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦æ¸²æŸ“ä¸€ä¸ªè¿™æ ·çš„elementæ ‘ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Didact.render(</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">p</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">a</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h2</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">  container</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>render</code>ä¸­æˆ‘ä»¬å°†ä¼šåˆ›å»ºä¸€ä¸ª<code>root fiber</code>ï¼Œå¹¶æŠŠå®ƒè®¾ç½®ä¸º<code>nextUnitOfWork</code>ã€‚æ¥ä¸‹æ¥çš„ä»»åŠ¡å°†ä¼šåœ¨<code>performUnitOfWork</code>ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ä¼šå¯¹æ¯ä¸ªfiberåšä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æŠŠå…ƒç´ æ·»åŠ åˆ°DOMä¸­</li>
<li>ä¸ºå…ƒç´ çš„å­©å­åˆ›å»º<code>fibers</code></li>
<li>é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡</li>
</ol>
<p>ï¼ˆä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰çœ‹å‡ºæ¥ï¼Œå…¶å®è¿˜æ˜¯é€’å½’ï¼Œåªä¸è¿‡æˆ‘ä»¬æ²¡æœ‰åœ¨é€’å½’é‡Œé¢ä¸å‡æ€ç´¢åœ°æ¸²æŸ“æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ï¼‰</p>
<p>å­¦è¿‡æ•°æ®ç»“æ„çš„åŒå­¦éƒ½åº”è¯¥çŸ¥é“æ ‘é•¿å•¥æ ·ï¼š</p>
<p><img src="C:\Users\luna6\AppData\Roaming\Typora\typora-user-images\image-20211018223652632.png" alt="image-20211018223652632"></p>
<p>å°±é•¿fiberæ ‘è¿™æ ·ï¼å…¶å®æ˜¯fiberæ ‘å°±é•¿æ ‘è¿™æ ·ğŸ˜€é€‰æ‹©è¿™ç§æ•°æ®ç»“æ„å½“ç„¶æ˜¯ä¸ºäº†æ–¹ä¾¿éå†äº†ï¼Œæ¯ä¸ªfiberéƒ½é“¾æ¥ç€å®ƒçš„ç¬¬ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œç›¸é‚»çš„å…„å¼ŸèŠ‚ç‚¹å’Œå®ƒçš„çˆ¶èŠ‚ç‚¹ã€‚</p>
<p>å½“æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªfiberä¸Šçš„ä»»åŠ¡æ—¶ï¼Œå¦‚æœä»–æœ‰<code>child</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå­©å­fiberå°±ä¼šæ˜¯ä»»åŠ¡æ‰§è¡Œçš„ä¸‹ä¸€ä¸ªå•å…ƒã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å®Œæˆäº†<code>div</code>fiberä¸Šçš„ä»»åŠ¡æ—¶ï¼Œä¸‹ä¸€ä¸ªå•å…ƒå°†ä¼šæ˜¯<code>h1</code>fiberã€‚</p>
<p>å¦‚æœä¸€ä¸ªfiberæ²¡æœ‰<code>child</code>ï¼Œæˆ‘ä»¬æŠŠ<code>sibling</code>å½“ä½œä»»åŠ¡çš„ä¸‹ä¸€ä¸ªå•å…ƒã€‚æ¯”å¦‚ï¼Œ<code>p</code>fiberæ²¡æœ‰<code>child</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ƒå®Œæˆä¹‹åæ¥åˆ°äº†<code>a</code>fiberã€‚</p>
<p>å†å¦‚æœä¸€ä¸ªfiberæ—¢æ²¡æœ‰<code>child</code>ä¹Ÿæ²¡æœ‰<code>sibling</code>å‘¢ï¼Œæˆ‘ä»¬æ‰¾åˆ°å®ƒçš„â€œå”å”â€ï¼š<code>parent</code>çš„<code>sibling</code>ã€‚å°±åƒ<code>a</code>fiberå’Œ<code>h2</code>fiberçš„å…³ç³»ã€‚</p>
<p>å½“ç„¶å•¦ï¼Œå¦‚æœ<code>parent</code>ä¹Ÿæ²¡æœ‰<code>sibling</code>çš„è¯ï¼Œæˆ‘ä»¬å°±ä¸€ç›´é¡ºç€<code>parent</code>så‘ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°äº†ä¸€ä¸ªå…·æœ‰<code>sibling</code>çš„fiberæˆ–è€…åˆ°è¾¾äº†rootã€‚å¦‚æœæˆ‘ä»¬åˆ°è¾¾äº†rootï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å®Œæˆäº†æ­¤æ¬¡<code>render</code>çš„æ‰€æœ‰ä»»åŠ¡ã€‚ï¼ˆç†Ÿæ‚‰æ•°æ®ç»“æ„çš„åŒå­¦ä¸€å®šå¾ˆå¼€å¿ƒå§ï¼è¿™ä¸å°±æ˜¯å…ˆæ ¹éå†çš„è¿‡ç¨‹å˜›ğŸ˜„ï¼‰</p>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬å®ç°ä»£ç éƒ¨åˆ†ï¼š</p>
<p>é¦–å…ˆæŠŠrenderå‡½æ•°ä¸­åˆ›å»ºDOMèŠ‚ç‚¹éƒ¨åˆ†çš„ä»£ç æŠ½å‡ºæ¥ï¼Œæ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„<code>createDom</code>å‡½æ•°ä¸­ï¼Œç¨åæˆ‘ä»¬ä¼šç”¨åˆ°å®ƒï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDom</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    fiber.type == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="built_in">document</span>.createElement(fiber.type)</span><br><span class="line">â€‹</span><br><span class="line">  <span class="keyword">const</span> isProperty = <span class="function"><span class="params">key</span> =&gt;</span> key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(fiber.props)</span><br><span class="line">    .filter(isProperty)</span><br><span class="line">    .forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = fiber.props[name]</span><br><span class="line">    &#125;)</span><br><span class="line">â€‹</span><br><span class="line">  <span class="keyword">return</span> dom</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>render</code>å‡½æ•°ä¸­æˆ‘ä»¬æŠŠfiber treeçš„rootè®¾ç½®ä¸º<code>nextUnitOfWork</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span><br><span class="line">  nextUnitOfWork = &#123;</span><br><span class="line">    <span class="attr">dom</span>: container,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">children</span>: [element],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå½“æµè§ˆå™¨å‡†å¤‡å¥½æ—¶ï¼Œå®ƒä¼šå›è°ƒæˆ‘ä»¬çš„<code>workLoop</code>ï¼Œæˆ‘ä»¬å°†ä¼šä»<code>root</code>å¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹å¹¶æŠŠå®ƒæ·»åŠ åˆ°DOMä¸­ã€‚æˆ‘ä»¬ç”¨<code>fiber.dom</code>å±æ€§æ¥è·Ÿè¸ªè¿™ä¸ªDOMèŠ‚ç‚¹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.dom) &#123;</span><br><span class="line">    fiber.dom = createDom(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.parent) &#123;</span><br><span class="line">    fiber.parent.dom.appendChild(fiber.dom)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO create new fibers</span></span><br><span class="line">  <span class="comment">// TODO return next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸ºæ¯ä¸ª<code>child</code>åˆ›å»ºä¸€ä¸ªæ–°çš„fiberï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elements = fiber.props.children</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.type,</span><br><span class="line">      <span class="attr">props</span>: element.props,</span><br><span class="line">      <span class="attr">parent</span>: fiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æŠŠå®ƒä½œä¸ºä¸€ä¸ª<code>child</code>æˆ–è€…<code>sibling</code>åŠ å…¥fiber treeï¼Œè¿™å–å†³äºå®ƒæ˜¯ä¸æ˜¯ç¬¬ä¸€ä¸ª<code>child</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.child = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.sibling = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br></pre></td></tr></table></figure>

<p>æœ€åæˆ‘ä»¬å¯»æ‰¾ä»»åŠ¡ä¸­çš„ä¸‹ä¸€ä¸ªå•å…ƒã€‚æˆ‘ä»¬é¦–å…ˆå¯»æ‰¾<code>child</code>ï¼Œæ¥ä¸‹æ¥æ˜¯<code>sibling</code>ï¼Œç„¶åæ˜¯<code>uncle</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fiber.child) &#123;</span><br><span class="line">   <span class="keyword">return</span> fiber.child</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line"> <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">   <span class="keyword">if</span> (nextFiber.sibling) &#123;</span><br><span class="line">     <span class="keyword">return</span> nextFiber.sibling</span><br><span class="line">   &#125;</span><br><span class="line">   nextFiber = nextFiber.parent</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯æˆ‘ä»¬çš„<code>performUnitOfWork</code>è¾£ï¼</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hemengting.xyz/2021/10/17/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAReact/" data-id="ckyjxbgil000ns4ubhg8mc8et" data-title="ä»0å¼€å§‹å®ç°ä¸€ä¸ªReact" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react-babel/" rel="tag">react babel</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/10/20/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAReact%E4%B8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ä»0å¼€å§‹å®ç°ä¸€ä¸ªReactä¸‹
        
      </div>
    </a>
  
  
    <a href="/2021/10/12/test/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">test</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-mysql-navicat/" rel="tag">docker mysql navicat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html-%E7%BF%BB%E8%AF%91/" rel="tag">html,ç¿»è¯‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-babel/" rel="tag">react babel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-mysql-navicat/" style="font-size: 10px;">docker mysql navicat</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/html-%E7%BF%BB%E8%AF%91/" style="font-size: 10px;">html,ç¿»è¯‘</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/react-babel/" style="font-size: 10px;">react babel</a> <a href="/tags/webpack/" style="font-size: 20px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/01/18/%E5%89%8D%E7%AB%AF%E4%B8%8EHTML/">é’è®­è¥ç¬”è®°ä¸€ å‰ç«¯ä¸HTML</a>
          </li>
        
          <li>
            <a href="/2022/01/18/wiproot%20setState%20=%20nextUnitOfwork/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/12/10/%E4%BD%BF%E7%94%A8navicat%E8%BF%9E%E6%8E%A5%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84docker%E4%B8%AD%E7%9A%84mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%87%E7%A8%8B/">ä½¿ç”¨navicatè¿æ¥äº‘æœåŠ¡å™¨çš„dockerä¸­çš„mysqlæ•°æ®åº“è¿‡ç¨‹</a>
          </li>
        
          <li>
            <a href="/2021/12/05/docker%E6%8C%87%E4%BB%A4%E6%B1%87%E6%80%BB/">dockeræŒ‡ä»¤æ±‡æ€»</a>
          </li>
        
          <li>
            <a href="/2021/10/29/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AA%E8%83%BD%E5%9C%A8React%E5%87%BD%E6%95%B0%E7%9A%84%E6%9C%80%E9%A1%B6%E5%B1%82%E8%B0%83%E7%94%A8Hook/">ä¸ºä»€ä¹ˆåªèƒ½åœ¨Reactå‡½æ•°çš„æœ€é¡¶å±‚è°ƒç”¨Hook?</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 He Mengting<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>